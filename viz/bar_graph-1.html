<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'>
		<style type='text/css' media='screen, print'>
			body  { margin: 30px 50px; font-family: sans-serif; }
			line, polyline, path { stroke: black; fill: none; }
		</style>
		<title>Top 20 countries by player count</title>
	</head>
	<body>
    <h1 class="title">FIDE Chess Players</h1>
    <h4>Top 20 countries by </h4>
    <div id="controls"></div>
    <div id="chart"></div>
		<script src='../vendor/d3-7.8.5/dist/d3.js'></script>
		<script>

// loading gzipped tsv files
async function tsvgz(input, row) { 
	let blob = await d3.blob(`${input}.gz`);
	const stream = blob.stream().pipeThrough(new DecompressionStream('gzip'));
	return d3.tsvParse(await new Response(stream).text(), row);
}

let categories = new Map([
  ['women',   (p, junior_year) => p.sex == 'F'],
  ['juniors', (p, junior_year) => p.birthyear >= junior_year], 
]);

Promise.all([
	tsvgz('../data/ratings.tsv', d => ({
		id:     +d['#id'],
		month:   d.month,
		rating: +d.rating,
		games:  +d.games,
	})),

	d3.tsv('../data/players.tsv', d => ({
		id:         +d['#id'],
		name:        d.name,
		fed:         d.fed,
		sex:         d.sex,
		birthyear:  +d.birthyear,
		max_rating: +d.max_rating,
		month:       d.month,
	})),
	
	d3.tsv('../data/countries.tsv', d => ({
		country:   d['#country'],
		iso3:      d.alpha3,
		fed:       d.ioc,
	})),
	
]).then(function(datasets) {
  
	// data
	let ratings = datasets[0];                         // ratings series
	let players = d3.index(datasets[1], p => p.id);    // players index
	let countries = d3.index(datasets[2], c => c.fed); // countries index	

  let h4 = d3.select("h4");
	// category dropdown
  let dropdown_category = h4.append("select");

  dropdown_category.selectAll("option")
    .data(["women", "juniors"])
    .join("option")
    .attr("value", d => d)
    .text(d => d);

  h4.append("span").text(" for month ");

// month dropdown (from ratings months)

  let dropdown_month = h4.append("select");
  let months = [...new Set(ratings.map(d => d.month))].sort(d3.descending);

  dropdown_month.selectAll("option")
                .data(months)
                .join("option")
                .attr("value", d => d)
                .text(d => d);

  // Scales and axis group
  const margin = { top: 20, right: 20, bottom: 80, left: 70 };
  const width  = 900;
  const height = 450;

  const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

  const g = svg.append("g")
               .attr("transform", `translate(${margin.left},${margin.top})`);

  const innerWidth  = width - margin.left - margin.right;
  const innerHeight = height - margin.top - margin.bottom;

  const x = d3.scaleBand()
              .range([0, innerWidth])
              .padding(0.15);

  const y = d3.scaleLinear()
              .range([innerHeight, 0]);

  const xAxisG = g.append("g")
                  .attr("transform", `translate(0,${innerHeight})`);

  const yAxisG = g.append("g");

// Y label
  svg.append("text")
     .attr("x", -(margin.top + innerHeight / 2))
     .attr("y", 18)
     .attr("transform", "rotate(-90)")
     .attr("text-anchor", "middle")
     .text("Number of players");

// X label
  svg.append("text")
     .attr("x", margin.left + innerWidth / 2)
     .attr("y", height - 10)
     .attr("text-anchor", "middle")
     .text("Country");


//Aggregate active players in top 20 countries
  function countryCounts(month, category) {
    var [y, m] = month.split('-');
    y = +y;
    let junior_year = y - 18;               
    var category_filter = categories.get(category);

  //get active player IDs for the chosen month
    let active = ratings
      .filter(d => `${y-1}-${m}` < d.month && d.month <= month)
      .filter(d => {
    let p = players.get(d.id);
      return p && category_filter(p, junior_year);
    });

  //Unique players
  let activeIds = new Set(active.map(d => d.id));

  let counts = d3.rollups(
  Array.from(activeIds, id => players.get(id)),
  P => P.length,
  p => countries.get(p.fed)?.country ?? "Unknown"
  );

  //Convert to objects & sort
  return counts
    .map(([country, count]) => ({ country, count }))
    .sort((a, b) => d3.descending(a.count, b.count))
    .slice(0, 20);
}


function update(month, category) {
  const data = countryCounts(month, category);

  // update scales
  x.domain(data.map(d => d.country));
  y.domain([0, d3.max(data, d => d.count)]).nice();

  // update axes
  xAxisG.call(d3.axisBottom(x))
    .selectAll("text")
    .attr("transform", "rotate(-40)")
    .style("text-anchor", "end");

  yAxisG.call(d3.axisLeft(y));

  // update bars
  g.selectAll("rect.bar")
    .data(data, d => d.country)
    .join("rect")
    .attr("class", "bar")
    .attr("x", d => x(d.country))
    .attr("y", d => y(d.count))
    .attr("width", x.bandwidth())
    .attr("height", d => innerHeight - y(d.count))
    .attr("fill", "#7c3aed")        
    .attr("stroke", "#4c1d95")      
    .attr("stroke-width", 0.5);
}
update(dropdown_month.property("value"), dropdown_category.property("value"));


dropdown_category.on("change", () => {
  update(dropdown_month.property("value"), dropdown_category.property("value"));
});
dropdown_month.on("change", () => {
  update(dropdown_month.property("value"), dropdown_category.property("value"));
});

});

		</script>
	</body>
</html>
